# 프로덕션 초안용 compose 파일이다.
# dev와 동일한 구조를 유지하되 backend의 --reload를 제거했다.
# 기본 APP_ENV는 production으로 설정해 동작 분기를 단순화한다.

services:
  # 외부 진입점: /api는 backend, 그 외 경로는 frontend로 전달한다.
  portal:
    image: nginx:alpine
    container_name: app_portal
    ports:
      - "${PORTAL_HTTP_PORT:-8080}:80"
    volumes:
      - ../infra/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    networks:
      app_net:

  # API 앱: 프로덕션 초안에서는 reload 없이 실행한다.
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: app_backend
    working_dir: /app
    command: uvicorn src.main:app --host 0.0.0.0 --port ${BACKEND_PORT:-8000}
    environment:
      APP_ENV: ${APP_ENV:-production}
      TZ: ${TZ:-Asia/Seoul}
      PROJECT_NAME: ${PROJECT_NAME:-govpage}
      BACKEND_PORT: ${BACKEND_PORT:-8000}
      DATA_ROOT: ${DATA_ROOT:-/data}
      DATA_WORK: ${DATA_WORK:-/data/work}
      DATA_DB: ${DATA_DB:-/data/db}
      DATA_LOGS: ${DATA_LOGS:-/data/logs}
    volumes:
      - ../backend:/app
      - ../data:/data
    expose:
      - "${BACKEND_PORT:-8000}"
    networks:
      app_net:
        aliases:
          - app_backend

  # UI 앱: base path 변수만 받아 동일한 개발 서버 커맨드를 사용한다.
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: app_frontend
    working_dir: /app
    command: npm run dev -- --host 0.0.0.0 --port ${FRONTEND_PORT:-5173}
    environment:
      APP_ENV: ${APP_ENV:-production}
      TZ: ${TZ:-Asia/Seoul}
      FRONTEND_PORT: ${FRONTEND_PORT:-5173}
      VITE_BASE_PATH: ${VITE_BASE_PATH:-/govpage}
    volumes:
      - ../frontend:/app
      - frontend_node_modules:/app/node_modules
    expose:
      - "${FRONTEND_PORT:-5173}"
    networks:
      app_net:
        aliases:
          - app_frontend

networks:
  app_net:
    driver: bridge

volumes:
  frontend_node_modules:
