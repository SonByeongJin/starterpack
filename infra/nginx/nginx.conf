# 개발용 포털 nginx 템플릿 파일이다.
# PROJECT_NAME을 주입해 /{PROJECT_NAME}/ 경로를 기준으로 프록시한다.
# 루트(/) 접근은 /{PROJECT_NAME}/로 리다이렉트한다.

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    server_name _;

    # 루트 접근은 프로젝트 prefix 경로로 보낸다.
    location = / {
        return 302 /${PROJECT_NAME}/;
    }

    # trailing slash를 강제해 상대 경로 깨짐을 방지한다.
    location = /${PROJECT_NAME} {
        return 301 /${PROJECT_NAME}/;
    }

    # 기본 API 요청(/api/*)을 backend의 /api/*로 전달한다.
    location /api/ {
        proxy_pass http://backend:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 프로젝트 prefix API 요청을 backend의 /api/*로 전달한다.
    location /${PROJECT_NAME}/api/ {
        proxy_pass http://backend:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 프로젝트 UI 요청을 frontend 개발 서버로 전달한다.
    location /${PROJECT_NAME}/ {
        proxy_pass http://frontend:5173;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_cache_bypass $http_upgrade;
    }

    # 그 외 경로는 개발 편의상 frontend로 전달한다.
    location / {
        proxy_pass http://frontend:5173;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_cache_bypass $http_upgrade;
    }
}
