# 개발용 compose 파일이다.
# portal(nginx), backend(FastAPI), frontend(Vite)를 한 네트워크로 묶는다.
# 포트/경로 값은 .env의 환경변수를 기본으로 사용한다.

services:
  # 외부 진입점: /api는 backend, 그 외 경로는 frontend로 전달한다.
  portal:
    image: nginx:alpine
    ports:
      - "${PORTAL_HTTP_PORT:-18080}:80"
    environment:
      PROJECT_NAME: ${PROJECT_NAME:-temp}
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/templates/default.conf.template:ro
    depends_on:
      - backend
      - frontend
    networks:
      app_net:

        # API 앱: 코드 변경 즉시 반영되도록 --reload를 사용한다.
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    working_dir: /app
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    environment:
      APP_ENV: ${APP_ENV:-development}
      TZ: ${TZ:-Asia/Seoul}
      PROJECT_NAME: ${PROJECT_NAME:-temp}
      BACKEND_PORT: 8000
      PYTHONPATH: /app
      DATA_ROOT: ${DATA_ROOT:-/data}
      DATA_WORK: ${DATA_WORK:-/data/work}
      DATA_DB: ${DATA_DB:-/data/db}
      DATA_LOGS: ${DATA_LOGS:-/data/logs}
    volumes:
      - ./backend:/app
      - ./data:/data
    expose:
      - "8000"
    networks:
      app_net:

        # UI 앱: VITE_BASE_PATH를 받아 base path 환경에 맞춰 실행한다.
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dev
    working_dir: /app
    command: npm run dev -- --host 0.0.0.0 --port 5173
    environment:
      APP_ENV: ${APP_ENV:-development}
      TZ: ${TZ:-Asia/Seoul}
      FRONTEND_PORT: 5173
      VITE_BASE_PATH: ${VITE_BASE_PATH:-/temp}
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    expose:
      - "5173"
    networks:
      app_net:


networks:
  app_net:
    driver: bridge

volumes:
  frontend_node_modules:
